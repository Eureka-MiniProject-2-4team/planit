<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
</head>
<body>
<div>
  <h2>회원가입</h2>
  <form onsubmit="submitForm(event)">
    <label>이름</label><br>
    <input type="text" id="userName" required minlength="2" maxlength="20" style="text-transform: lowercase;"><br><br>

    <label>이메일</label><br>
    <input type="email" id="email" required oninput="resetDuplicate('email')" style="text-transform: lowercase;">
    <button type="button" onclick="checkDuplicate('email')">중복 확인</button>
    <span id="emailChecked" style="color:green"></span><br><br>

    <label>전화번호</label><br>
    <input type="text" id="phoneNumber" required oninput="resetDuplicate('phoneNumber')">
    <button type="button" onclick="checkDuplicate('phoneNumber')">중복 확인</button>
    <span id="phoneNumberChecked" style="color:green"></span><br><br>

    <label>비밀번호</label><br>
    <input type="password" id="password" required oninput="validatePassword()" />
    <div id="pwMsg"></div><br>

    <label>비밀번호 확인</label><br>
    <input type="password" id="passwordConfirm" required oninput="validatePassword()" />
    <div id="pwCheckMsg"></div><br>

    <label>닉네임</label><br>
    <input type="text" id="nickName" required minlength="2" maxlength="12" oninput="resetDuplicate('nickName')" style="text-transform: lowercase;">
    <button type="button" onclick="checkDuplicate('nickName')">중복 확인</button>
    <span id="nickNameChecked" style="color:green"></span><br><br>

    <button type="submit" id="submitBtn" disabled>회원가입</button>
  </form>
</div>

<script>
  const duplicateFlags = {
    email: false,
    phoneNumber: false,
    nickName: false
  };

  function checkDuplicate(type) {
    const input = document.getElementById(type);
    const value = input.value;

    if (!value) {
      alert(`${type === 'email' ? '이메일' : type === 'phoneNumber' ? '전화번호' : '닉네임'}을 입력해주세요.`);
      return;
    }

    fetch(`/auth/check-${type}?value=${encodeURIComponent(value)}`)
            .then(res => res.json())
            .then(data => {
              const msg = document.getElementById(`${type}Checked`);
              if (data.result === 'SUCCESS') {
                duplicateFlags[type] = true;
                msg.textContent = "사용 가능한 값입니다.";
                msg.style.color = "green";
              } else {
                duplicateFlags[type] = false;
                msg.textContent = "이미 사용 중입니다.";
                msg.style.color = "red";
              }
              checkFormValidity();
            })
            .catch(() => alert("중복 확인 중 오류 발생"));
  }

  function resetDuplicate(type) {
    duplicateFlags[type] = false;
    document.getElementById(`${type}Checked`).textContent = "";
    checkFormValidity();
  }

  function validatePassword() {
    const pw = document.getElementById('password').value;
    const pwConfirm = document.getElementById('passwordConfirm').value;
    const pwMsg = document.getElementById('pwMsg');
    const pwCheckMsg = document.getElementById('pwCheckMsg');

    const pwValid = pw.length >= 8 && /[!@#$%^&*(),.?":{}|<>_]/.test(pw);

    pwMsg.textContent = !pw ? "" : pwValid ? "사용 가능한 비밀번호입니다." : "비밀번호는 8자 이상이며 특수문자를 포함해야 합니다.";
    pwMsg.style.color = pwValid ? "green" : "red";

    pwCheckMsg.textContent = !pwConfirm ? "" : pw !== pwConfirm ? "비밀번호가 일치하지 않습니다." : "비밀번호가 일치합니다.";
    pwCheckMsg.style.color = pw !== pwConfirm ? "red" : "green";

    checkFormValidity();
  }

  function checkFormValidity() {
    const userName = document.getElementById('userName').value;
    const email = document.getElementById('email').value;
    const phoneNumber = document.getElementById('phoneNumber').value;
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;
    const nickName = document.getElementById('nickName').value;

    const pwValid = password.length >= 8 && /[!@#$%^&*(),.?":{}|<>_]/.test(password);
    const allFieldsFilled = userName && email && phoneNumber && password && passwordConfirm && nickName;
    const passwordsMatch = password === passwordConfirm;
    const allDuplicatesChecked = duplicateFlags.email && duplicateFlags.phoneNumber && duplicateFlags.nickName;

    document.getElementById('submitBtn').disabled = !(allFieldsFilled && pwValid && passwordsMatch && allDuplicatesChecked);
  }

  function submitForm(event) {
    event.preventDefault();

    const requiredChecks = ['email', 'phoneNumber', 'nickName'];
    for (const field of requiredChecks) {
      if (!duplicateFlags[field]) {
        alert(`모든 중복 확인을 완료해주세요.`);
        return;
      }
    }

    const pw = document.getElementById('password').value;
    const pwConfirm = document.getElementById('passwordConfirm').value;
    const pwValid = pw.length >= 8 && /[!@#$%^&*(),.?":{}|<>_]/.test(pw);

    if (!pwValid) {
      alert("비밀번호는 8자 이상이며 특수문자를 포함해야 합니다.");
      return;
    }

    if (pw !== pwConfirm) {
      alert("비밀번호가 일치하지 않습니다.");
      return;
    }

    const payload = {
      userName: document.getElementById('userName').value,
      email: document.getElementById('email').value,
      phoneNumber: document.getElementById('phoneNumber').value,
      password: pw,
      nickName: document.getElementById('nickName').value
    };

    fetch('/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
            .then(res => res.json())
            .then(data => {
              alert(data.message || "회원가입 성공");
              if (data.result === 'SUCCESS') {
                window.location.href = '/login';
              }
            })
            .catch(() => alert("회원가입 실패"));
  }

  window.onload = function () {
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', function () {
        if (['email', 'phoneNumber', 'nickName'].includes(this.id)) {
          resetDuplicate(this.id);
        }
        checkFormValidity();
      });
    });
  };
</script>
</body>
</html>
