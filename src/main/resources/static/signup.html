<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
</head>
<body>
<div>
  <h2>회원가입</h2>
  <form onsubmit="submitForm(event)">
    <label>이름</label><br>
    <input type="text" id="username" required minlength="2" maxlength="20" pattern="^[a-z가-힣]{2,20}$" title="2~20자의 소문자 한글 또는 영문만 허용" style="text-transform: lowercase;"><br><br>

    <label>이메일</label><br>
    <input type="email" id="email" required pattern="^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="이메일은 소문자만 입력 가능합니다." oninput="resetDuplicate('email')" style="text-transform: lowercase;">
    <button type="button" onclick="checkDuplicate('email')">중복 확인</button>
    <span id="emailChecked" style="color:green"></span><br><br>

    <label>전화번호</label><br>
    <input type="text" id="phoneNumber" required pattern="^010[0-9]{7,8}$" title="010으로 시작하는 10~11자리 숫자" oninput="resetDuplicate('phoneNumber')">
    <button type="button" onclick="checkDuplicate('phoneNumber')">중복 확인</button>
    <span id="phoneNumberChecked" style="color:green"></span><br><br>

    <label>비밀번호</label><br>
    <input type="password" id="password" required pattern="^(?=.*[\W_]).{8,}$" title="비밀번호는 8자 이상이며 특수문자를 포함해야 합니다." oninput="validatePassword()"><br>
    <div id="pwMsg"></div><br>

    <label>비밀번호 확인</label><br>
    <input type="password" id="passwordConfirm" required oninput="validatePassword()">
    <div id="pwCheckMsg"></div><br>

    <label>닉네임</label><br>
    <input type="text" id="nickname" required minlength="2" maxlength="12" pattern="^[a-z0-9가-힣]{2,12}$" title="닉네임은 소문자, 숫자, 한글만 허용됩니다." oninput="resetDuplicate('nickname')" style="text-transform: lowercase;">
    <button type="button" onclick="checkDuplicate('nickname')">중복 확인</button>
    <span id="nicknameChecked" style="color:green"></span><br><br>

    <button type="submit" id="submitBtn" disabled>회원가입</button>
  </form>
</div>
<script>
  const duplicateFlags = {
    email: false,
    phoneNumber: false,
    nickname: false
  };

  function checkDuplicate(type) {
    const input = document.getElementById(type);
    const value = input.value;

    if (!value) {
      alert(`${type === 'email' ? '이메일' : type === 'phoneNumber' ? '전화번호' : '닉네임'}을 입력해주세요.`);
      return;
    }

    // 입력값 형식 검사
    if (!input.checkValidity()) {
      alert(`${type === 'email' ? '이메일' : type === 'phoneNumber' ? '전화번호' : '닉네임'} 형식이 올바르지 않습니다.`);
      return;
    }

    fetch(`/auth/check-${type}?value=` + encodeURIComponent(value))
            .then(res => res.json())
            .then(data => {
              const msg = document.getElementById(`${type}Checked`);
              if (data.result === 'SUCCESS') {
                duplicateFlags[type] = true;
                msg.textContent = "사용 가능한 값입니다.";
                msg.style.color = "green";
              } else {
                duplicateFlags[type] = false;
                msg.textContent = "이미 사용 중입니다.";
                msg.style.color = "red";
              }
              checkFormValidity();
            })
            .catch(err => alert("중복 확인 중 오류 발생"));
  }

  function resetDuplicate(type) {
    duplicateFlags[type] = false;
    document.getElementById(`${type}Checked`).textContent = "";
    checkFormValidity();
  }

  function validatePassword() {
    const pw = document.getElementById('password').value;
    const pwConfirm = document.getElementById('passwordConfirm').value;
    const pwMsg = document.getElementById('pwMsg');
    const pwCheckMsg = document.getElementById('pwCheckMsg');

    // 비밀번호 형식 검증
    const pwValid = pw.length >= 8 && /[\W_]/.test(pw);

    if (pw === '') {
      pwMsg.textContent = "";
    } else if (!pwValid) {
      pwMsg.textContent = "비밀번호는 8자 이상이며 특수문자를 포함해야 합니다.";
      pwMsg.style.color = "red";
    } else {
      pwMsg.textContent = "사용 가능한 비밀번호입니다.";
      pwMsg.style.color = "green";
    }

    // 비밀번호 일치 검증
    if (pwConfirm === '') {
      pwCheckMsg.textContent = "";
    } else if (pw !== pwConfirm) {
      pwCheckMsg.textContent = "비밀번호가 일치하지 않습니다.";
      pwCheckMsg.style.color = "red";
    } else if (pwValid && pw === pwConfirm) {
      pwCheckMsg.textContent = "비밀번호가 일치합니다.";
      pwCheckMsg.style.color = "green";
    }

    checkFormValidity();
  }

  function checkFormValidity() {
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const phoneNumber = document.getElementById('phoneNumber').value;
    const password = document.getElementById('password').value;
    const passwordConfirm = document.getElementById('passwordConfirm').value;
    const nickname = document.getElementById('nickname').value;

    const pwValid = password.length >= 8 && /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const allFieldsFilled = username && email && phoneNumber && password && passwordConfirm && nickname;
    const passwordsMatch = password === passwordConfirm;
    const allDuplicatesChecked = duplicateFlags.email && duplicateFlags.phoneNumber && duplicateFlags.nickname;

    document.getElementById('submitBtn').disabled = !(allFieldsFilled && pwValid && passwordsMatch && allDuplicatesChecked);
  }

  function submitForm(event) {
    event.preventDefault();

    const requiredChecks = ['email', 'phoneNumber', 'nickname'];
    for (const field of requiredChecks) {
      if (!duplicateFlags[field]) {
        alert(`모든 중복 확인을 완료해주세요.`);
        return;
      }
    }

    const pw = document.getElementById('password').value;
    const pwConfirm = document.getElementById('passwordConfirm').value;
    const pwValid = pw.length >= 8 && /[\W_]/.test(pw);

    if (!pwValid) {
      alert("비밀번호는 8자 이상이며 특수문자를 포함해야 합니다.");
      return;
    }
    if (pw !== pwConfirm) {
      alert("비밀번호가 일치하지 않습니다.");
      return;
    }

    const payload = {
      username: document.getElementById('username').value,
      email: document.getElementById('email').value,
      phoneNumber: document.getElementById('phoneNumber').value,
      password: pw,
      nickname: document.getElementById('nickname').value
    };

    fetch('/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
            .then(res => res.json())
            .then(data => {
              alert(data.message || "회원가입 성공");
              if (data.result === 'SUCCESS') {
                window.location.href = '/login'; // 성공 시 로그인 페이지로 이동
              }
            })
            .catch(err => alert("회원가입 실패"));
  }

  // 페이지 로드 시 폼 유효성 검사
  window.onload = function() {
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        // 입력 필드가 형식에 맞지 않으면 중복 확인 상태 초기화
        if (!this.checkValidity() && ['email', 'phoneNumber', 'nickname'].includes(this.id)) {
          resetDuplicate(this.id);
        }
        checkFormValidity();
      });
    });
  };
</script>
</body>
</html>